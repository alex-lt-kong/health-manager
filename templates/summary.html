<!DOCTYPE html>
<link rel="shortcut icon" href="{{app_address}}/static/favicon.png">
<link rel="stylesheet" href="//monitor.sz.lan/resources/w3.css">
<script src="//monitor.sz.lan/resources/monitor.js"></script>
<script src="{{app_address}}/static/lib/jquery/3.6.0/jquery.{{mode}}.js"></script>
<script src="//monitor.sz.lan/resources/moment.js-2.18.1/moment.min.js"></script>
<script src="//monitor.sz.lan/resources/chart.js-2.8.0/Chart.min.js"></script>
<script src="//monitor.sz.lan/resources/chart.js-2.8.0/Chart.bundle.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1">
<html>
<head><title>简报[{{username}}] - 体重管理器</title></head>
<body>
<div class="w3-container w3-responsive" style="max-width:110em; display:block; margin-left:auto; margin-right:auto; margin-top:0.5rem; padding:0.5rem; padding-bottom:1rem; ">
  <div class="w3-card-4">
    <div class="w3-container w3-blue">
      <h3>{{username}}的体重数据<span class="w3-right" style="margin-bottom:1rem;font-size:0.65em;"><a href="#" onclick="logout();">退出</a></span></h3>
    </div>
    <div class="w3-panel w3-leftbar w3-border-blue" style="margin-bottom:0px"><h5>概况</h5></div>
    <div class="w3-container w3-center w3-padding-8">
      <p id="last-record-time" style="margin-bottom:0px; margin-top:0px">载入中...</p>
      <p style="font-size:7vh;font-weight:bold;margin:0px;margin-top:-0.3rem;"><span id="latest-weight">载入中...</span>公斤</p>
      <p style="margin-top:-0.3rem;">备注：<span id="latest-remark">载入中...</span></p> 
  	</div>
  	<hr style="margin-top:0px; margin-left:2em; margin-right:2em;">
  	<div class="w3-panel w3-leftbar w3-border-blue" style="margin-bottom:0px"><h5>折线图</h5></div>
    <div class="w3-container w3-center w3-padding-16">
    
      <div class="chart-container" style="width:99%; height:300px;">
        <canvas id="myLineChart"></canvas>
      </div>
      <div style=" text-align: center;">
        跨度:
        <input id="days-radio-button-0" class="w3-radio" type="radio" name="days-radio-button" onclick="updateLineChartData(30);" >
        <label for="days-radio-button-0">1月</label>
        <input id="days-radio-button-1" class="w3-radio" type="radio" name="days-radio-button" onclick="updateLineChartData(120);" checked>
        <label for="days-radio-button-1">4月</label>
        <input id="days-radio-button-2" class="w3-radio" type="radio" name="days-radio-button" onclick="updateLineChartData(365);" >
        <label for="days-radio-button-2">1年</label>
        <input id="days-radio-button-3" class="w3-radio" type="radio" name="days-radio-button" onclick="updateLineChartData(730);" >
        <label for="days-radio-button-3">2年</label>
        <input id="days-radio-button-4" class="w3-radio" type="radio" name="days-radio-button" onclick="updateLineChartData(1461);" >
        <label for="days-radio-button-4">4年</label>
      </div>      
  	</div>
    <hr style="margin-top:0px; margin-left:2em; margin-right:2em;">
    <div class="w3-panel w3-leftbar w3-border-blue" style="margin-bottom:0px"><h5>统计表</h5></div>
    <div class="w3-container w3-center w3-padding-16">{{stat_table|safe}}</div>
  </div>
</div>
</body>
<script>

  window.onload = function() {
    logUserActivity('[weight-manager/summary] load', '{{username}}');
  };
  window.onunload = function() { logUserActivity('[weight-manager/summary] unload', '{{username}}'); };

  function logout() {
    logUserActivity('[weight-manager/record] logout', '{{username}}');
    window.location.replace('../logout/');
  }

  var remarks = [];
  var ctx = document.getElementById('myLineChart').getContext('2d');
  var myLineChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: '移动平均',
        data: [],
        fill: false,
        tension: 0.5,
        backgroundColor: '#f44336',
        borderColor: '#f44336',
        borderWidth: 1.75,
        pointRadius: 2
      },{
        label: '原始',
        data: [],
        fill: false,
        tension: 0.1,
        borderColor: "#f44336",
        borderWidth: 0.75,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      legend: { display: false },
      scales: {
        xAxes: [{
          gridLines: { display: false },
          type: "time",
          time: { 
            parser: 'YYYY-MM-DD HH:mm:ss',
            displayFormats: {
              'hour': 'YYYY-MM-DD',
              'day': 'YYYY-MM-DD',
              'month': 'YYYY-MM'
            },
            tooltipFormat: 'YYYY-MM-DD HH:mm'
          },
          display: true   
        }],
        yAxes: [{
          gridLines: { display: true },
          ticks: { beginAtZero: false },
        }]
      },
      tooltips: {
        callbacks: {
            label: function(tooltipItem, data) {
              var label = data.datasets[tooltipItem.datasetIndex].label;
              label += ': ' + (tooltipItem.yLabel) + ' KG'
              if (data.datasets[tooltipItem.datasetIndex].label == '移动平均')
                if (remarks[tooltipItem.index].length > 0)
                  label += ' (' + remarks[tooltipItem.index] + ')';
              return label;
            }
        },
        mode: 'index', // It basically means that tooltips for all points with the same index, i.e., x value will be shown
        intersect: false // if true, the tooltips callback will only be triggered when mouse is exactly over a point
      }
    }
  });
  $.get( "{{app_address}}/get-latest-data/?value_type=weight")
  .done(function(data,status,xhr) {
    $("#last-record-time").text(data['record_time']);
    $("#latest-weight").text(data['value']);
    $("#latest-remark").text(data['remark']);
  })
  .fail(function(jqXHR, textStatus, errorThrown) {
    alert("错误：" + textStatus);
  })
  .always(function() {
  });

  function updateLineChartData(days) {
    $.get( "{{app_address}}/get-data/?value_type=weight&days=" + days.toString())
      .done(function(data,status,xhr) {
        myLineChart.data.labels = data['record_times'];
        myLineChart.data.datasets[0].data = (data["values_ema"]);
        myLineChart.data.datasets[1].data = (data["values_raw"]);
        remarks = data["remarks"];
        myLineChart.update();
        logUserActivity('[weight-manager/summary] interval changed to ' + days.toString() + ' days', '{{username}}');
      })
      .fail(function(jqXHR, textStatus, errorThrown) {
        alert("错误：" + textStatus);
      })
      .always(function() {
      });
    }
  updateLineChartData(120);
</script>
</html>
